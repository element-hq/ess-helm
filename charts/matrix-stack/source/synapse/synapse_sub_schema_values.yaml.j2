{#
Copyright 2024-2025 New Vector Ltd
Copyright 2025 Element Creations Ltd

SPDX-License-Identifier: AGPL-3.0-only
#}

{% import 'sub_schema_values.yaml.j2' as sub_schema_values -%}

{% macro externalRedis() %}
## Details of an external Redis to use for worker coordination
## If set, the internal Redis deployment will be skipped
## This is useful for production environments where you want to use
## managed Redis services (AWS Elasticache, Azure Cache for Redis, etc.)
# externalRedis:
  ## Redis host
  # host:

  ## Redis port
  # port: 6379

  ## Redis database number (0-15)
  # db: 0

  ## Redis password (optional - many managed services require auth)
  ## It can either be provided inline in the Helm chart e.g.:
  ## password:
  ##   value: SecretValue
  ##
  ## Or it can be provided via an existing Secret e.g.:
  ## password:
  ##   secret: existing-secret
  ##   secretKey: key-in-secret
  # password: {}

  ## Enable TLS for Redis connection
  # tls: false
{%- endmacro %}

{% macro single_worker(workerType) %}
{{ workerType }}:
  ## Set to true to deploy this worker
  enabled: false

  ## Resources for this worker.
  ## If omitted the global Synapse resources are used
  # resources: {}

{{- sub_schema_values.probe("liveness", failureThreshold=8, periodSeconds=6, timeoutSeconds=2) | indent(2) }}
{{- sub_schema_values.probe("readiness", failureThreshold=8, periodSeconds=2, successThreshold=2, timeoutSeconds=2) | indent(2) }}
{{- sub_schema_values.probe("startup", failureThreshold=54, periodSeconds=2) | indent(2) }}
{%- endmacro %}

{% macro scalable_worker(workerType) %}
{{ workerType }}:
  ## Set to true to deploy this worker
  enabled: false

  ## The number of replicas of this worker to run
  replicas: 1

  ## Resources for this worker.
  ## If omitted the global Synapse resources are used
  # resources: {}

{{- sub_schema_values.probe("liveness", periodSeconds=6, timeoutSeconds=2) | indent(2) }}
{{- sub_schema_values.probe("readiness", periodSeconds=2, successThreshold=2, timeoutSeconds=2) | indent(2) }}
{{- sub_schema_values.probe("startup", failureThreshold=21, periodSeconds=2) | indent(2) }}
{%- endmacro %}
