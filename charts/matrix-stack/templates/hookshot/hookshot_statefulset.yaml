{{- /*
Copyright 2026 Element Creations Ltd

SPDX-License-Identifier: AGPL-3.0-only
*/ -}}

{{- with $.Values.hookshot -}}
{{- if .enabled -}}
apiVersion: apps/v1
kind: StatefulSet
metadata:
{{- with .annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
{{- end }}
  labels:
    k8s.element.io/hookshot-config-hash: "{{ include "element-io.hookshot.configmap-data"  (dict "root" $ "context" .) | sha1sum }}"
    k8s.element.io/hookshot-secret-hash: "{{ include "element-io.hookshot.secret-data"  (dict "root" $ "context" .) | sha1sum }}"
    {{ include "element-io.hookshot.labels" (dict "root" $ "context" (dict "image" .image "labels" .labels)) | nindent 4 }}
  name: {{ $.Release.Name }}-hookshot
  namespace: {{ $.Release.Namespace }}
spec:
  {{ include "element-io.ess-library.workloads.commonSpec" (dict "root" $ "context" (dict "nameSuffix" "hookshot" "kind" "StatefulSet" "componentValues" .)) | nindent 2 }}
  template:
    metadata:
      labels:
        k8s.element.io/hookshot-secret-hash: "{{ include "element-io.hookshot.secret-data" (dict "root" $ "context" .) | sha1sum }}"
        k8s.element.io/hookshot-config-hash: "{{ include "element-io.hookshot.configmap-data" (dict "root" $ "context" .) | sha1sum }}"
        {{- include "element-io.hookshot.labels" (dict "root" $ "context" (dict "image" .image "labels" .labels "withChartVersion" false)) | nindent 8 }}
{{- with .annotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
{{- end }}
    spec:
{{- with .hostAliases }}
      hostAliases:
        {{- tpl (toYaml . | nindent 8) $ }}
{{- end }}
{{- include "element-io.ess-library.pods.commonSpec" (dict "root" $ "context" (dict "componentValues" .
                                                                                    "instanceSuffix" "hookshot"
                                                                                    "kind" "StatefulSet"
                                                                                    "usesMatrixTools" true
                                                                                    "mountServiceAccountToken" false)) | nindent 6 }}
      initContainers:
{{- /* Add registration init container only if using dynamic registration */}}
{{- if not .appserviceRegistration }}
      {{- include "element-io.ess-library.render-registration-container" (dict "root" $ "context" (dict
          "nameSuffix" "hookshot"
          "containerName" "render-registration"
          "templatesVolume" "registration-templates"
          "outputFile" "hookshot-registration.yaml"
          "registrationTemplate" "hookshot-registration.yaml.tpl"
          "resources" .resources
          "containersSecurityContext" .containersSecurityContext
          "extraEnv" .extraEnv
          "extraVolumeMounts" .extraVolumeMounts
          "isHook" false
        )) | nindent 6 }}
{{- end }}
      {{- include "element-io.ess-library.render-config-container" (dict "root" $ "context"
            (dict "additionalPath" "hookshot.additional"
                  "nameSuffix" "hookshot"
                  "containerName" "render-config"
                  "underrides" (list "config-underride.yaml")
                  "overrides" (list "config-override.yaml")
                  "outputFile" "hookshot-config.yaml"
                  "arrayOverwriteKeys" ((list "permissions") | join ",")
                  "resources" .resources
                  "containersSecurityContext" .containersSecurityContext
                  "extraEnv" .extraEnv
                  "extraVolumeMounts" .extraVolumeMounts
                  "isHook" false)) | nindent 6 }}
      - name: http-wait-syn
        {{- include "element-io.ess-library.pods.image" (dict "root" $ "context" $.Values.matrixTools.image) | nindent 8 }}
{{- with .containersSecurityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
{{- end }}
        args:
        - tcpwait
        - -address
        - "{{ include "element-io.synapse.internal-hostport" (dict "root" $ "context" (dict "targetProcessType" "")) }}"
{{- with .resources }}
        resources:
          {{- toYaml . | nindent 10 }}
{{- end }}
{{- with .extraVolumeMounts }}
        volumeMounts:
  {{- range . }}
        - {{ (. | toYaml) | nindent 10 }}
  {{- end }}
{{- end }}
      {{- with .extraInitContainers }}
      {{- toYaml . | nindent 6 }}
      {{- end }}
      containers:
      - name: hookshot
        {{- include "element-io.ess-library.pods.image" (dict "root" $ "context" .image) | nindent 8 }}
{{- with .containersSecurityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
{{- end }}
        {{- include "element-io.ess-library.pods.env" (dict "root" $ "context" (dict "componentValues" . "componentName" "hookshot")) | nindent 8 }}
{{- with .resources }}
        resources:
          {{- toYaml . | nindent 10 }}
{{- end }}
        args:
        - "/bin/matrix-hookshot/App/BridgeApp.js"
        - /conf/hookshot-config.yaml
        {{- if .appserviceRegistration }}
        {{- /* Static registration - use provided-secret approach */}}
        - /secrets/{{ include "element-io.ess-library.init-secret-path" (
                dict "root" $
                "context" (dict
                  "secretPath" "hookshot.appserviceRegistration"
                  "initSecretKey" "HOOKSHOT_REGISTRATION"
                  "defaultSecretName" (include "element-io.hookshot.secret-name" (dict "root" $ "context" .))
                  "defaultSecretKey" "REGISTRATION"
                )
              ) }}
        {{- else }}
        {{- /* Dynamic registration - use generated registration file */}}
        - /conf/hookshot-registration.yaml
        {{- end }}
        ports:
        - containerPort: 9993
          name: appservice
          protocol: TCP
        - containerPort: 7775
          name: webhooks
          protocol: TCP
        - containerPort: 7777
          name: metrics
          protocol: TCP
        - containerPort: 7778
          name: widgets
          protocol: TCP
        startupProbe: {{- include "element-io.ess-library.pods.probe" .startupProbe | nindent 10 }}
          httpGet:
            path: /ready
            port: metrics
            scheme: HTTP
        livenessProbe: {{- include "element-io.ess-library.pods.probe" .livenessProbe | nindent 10 }}
          httpGet:
            path: /live
            port: metrics
            scheme: HTTP
        readinessProbe: {{- include "element-io.ess-library.pods.probe" .readinessProbe | nindent 10 }}
          httpGet:
            path: /ready
            port: metrics
            scheme: HTTP
        volumeMounts:
{{- if .enableEncryption }}
        - name: storage
          mountPath: /storage
{{- end }}
{{- range .extraVolumeMounts }}
        - {{ (. | toYaml) | nindent 10 }}
{{- end }}
        {{- include "element-io.ess-library.render-config-volume-mounts" (dict "root" $ "context"
              (dict "nameSuffix" "hookshot"
                    "outputFile" "hookshot-config.yaml")) | nindent 8 }}
        {{- if not .appserviceRegistration }}
        {{- /* Dynamic registration - mount generated registration file */}}
        - mountPath: /conf/hookshot-registration.yaml
          name: rendered-registration
          subPath: hookshot-registration.yaml
          readOnly: true
        {{- end }}
      volumes:
      {{- include "element-io.ess-library.render-config-volumes" (dict "root" $ "context"
              (dict "additionalPath" "hookshot.additional"
                    "nameSuffix" "hookshot")
            ) | nindent 6 }}
      {{- if not .appserviceRegistration }}
      {{- /* Dynamic registration - add registration volumes */}}
      {{- include "element-io.ess-library.render-registration-volumes" (dict "root" $ "context" (dict "nameSuffix" "hookshot" )) | nindent 6 }}
      {{- end }}
{{- range .extraVolumes }}
      - {{- (tpl (. | toYaml) $) | nindent 8 }}
{{- end }}
{{- if .enableEncryption }}
      - name: storage
        persistentVolumeClaim:
          claimName: {{ include "element-io.hookshot.pvcName" (dict "root" $) }}
{{- end }}
      - emptyDir:
          medium: Memory
        name: temp
{{- end }}
{{- end -}}