# Copyright 2025 New Vector Ltd
# Copyright 2025 Element Creations Ltd
#
# SPDX-License-Identifier: AGPL-3.0-only

name: dyff of rendered templates - comment
on:
  workflow_run:
    workflows: ["dyff of rendered templates"]
    types:
    - completed

permissions:
  actions: read
  pull-requests: write

jobs:
  manage-comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
    - name: Download dyff of templates
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        name: dyff-templates
        run-id: ${{ github.event.workflow_run.id }}

    - name: Load PR number
      id: pr-number
      run: |
        # This is already formatted as pr-number=<pr number>
        cat "pr-number.txt" >> "$GITHUB_OUTPUT"

    - name: Find dyff comment
      uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad  # v3
      id: find-dyff-comment
      with:
        issue-number: ${{ steps.pr-number.outputs.pr-number }}
        comment-author: 'github-actions[bot]'
        body-includes: 'dyff of changes in rendered templates'

    - name: Create or update comment
      uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9  # v4
      with:
        comment-id: ${{ steps.find-dyff-comment.outputs.comment-id }}
        issue-number: ${{ steps.pr-number.outputs.pr-number }}
        body-path: dyff-output.md
        edit-mode: replace
